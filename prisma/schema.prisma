// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id          String   @id @default(cuid())
  firebaseUid String   @unique
  email       String   @unique
  nom        String?
  phone       String?
  imageUrl    String?
  role        Role     @default(CLIENT)
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  restaurant  Restaurant?
  deliveries  Delivery[]
  cart        Cart?
  adresses   Adresses[] // Ajout de la relation aux adresses
  fcmTokens   FcmToken[]
  reviews     Review[]   // Avis laissés par l'utilisateur
}

model FcmToken {
  id        String   @id @default(cuid())
  token     String   @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  @@index([userId])
}

model Adresses {
  id         String    @id @default(cuid())
  rue        String
  ville      String
  etat       String?   // Région/État
  country    String
  user       User      @relation(fields: [userId], references: [id])
  userId     String
  quartier   Quartier? @relation(fields: [quartierId], references: [id])
  quartierId String?   // Référence au quartier pour le calcul des frais
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([quartierId])
}

model Restaurant {
  id                      String            @id @default(cuid())
  nom                     String
  adresse                 String
  phone                   String
  imageUrl                String?
  owner                   User              @relation(fields: [ownerId], references: [id])
  ownerId                 String            @unique
  products                Product[]
  menuDuJour              MenuDuJour[]
  orders                  Order[]
  reviews                 Review[]          // Avis sur le restaurant
  specialties             Specialty[]       // Spécialités du restaurant

  // Statut d'ouverture
  isOpen                  Boolean           @default(true)  // Restaurant ouvert/fermé

  // Configuration de la livraison
  deliveryPriceMode       DeliveryPriceMode @default(FIXED)
  fixedDeliveryFee        Float             @default(500)   // Prix fixe si mode FIXED
  deliveryZones           DeliveryZone[]    // Zones de livraison si mode ZONE_BASED
  estimatedDeliveryTimeMin Int              @default(15)    // Temps de livraison min (minutes)
  estimatedDeliveryTimeMax Int              @default(30)    // Temps de livraison max (minutes)
  minimumOrderAmount      Float             @default(0)     // Montant minimum de commande

  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
}

// Spécialités d'un restaurant (ex: "Pizza", "Sushi", "Burgers", "Africain")
model Specialty {
  id           String     @id @default(cuid())
  name         String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId String
  createdAt    DateTime   @default(now())

  @@unique([restaurantId, name]) // Une spécialité unique par restaurant
  @@index([restaurantId])
}

model Category {
  id        String    @id @default(cuid())
  nom      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}
model MenuDuJour {
  id           String         @id @default(cuid())
  nom          String
  description  String?
  imageUrl     String?
  prix         Float
  dateDebut    DateTime       // Date et heure de début de validité du menu
  dateFin      DateTime       // Date et heure de fin de validité du menu
  isActive     Boolean        @default(true) // Permet de désactiver manuellement un menu
  restaurant   Restaurant     @relation(fields: [restaurantId], references: [id])
  restaurantId String
  products     MenuProduct[]  // Relation many-to-many avec Product
  orderItems   OrderItem[]
  cartItems    CartItem[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([restaurantId])
  @@index([dateDebut, dateFin]) // Index pour les requêtes par date
}

// Table de liaison pour la relation many-to-many entre Menu et Product
model MenuProduct {
  id           String      @id @default(cuid())
  menu         MenuDuJour  @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId       String
  product      Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId    String
  ordre        Int         @default(0) // Ordre d'affichage dans le menu
  createdAt    DateTime    @default(now())

  @@unique([menuId, productId]) // Un produit ne peut être ajouté qu'une seule fois dans un menu
  @@index([menuId])
  @@index([productId])
}
model Product {
  id           String           @id @default(cuid())
  nom         String
  description  String?
  imageUrl     String?
  prixOriginal  Float
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id])
  restaurantId String
  category     Category?        @relation(fields: [categoryId], references: [id])
  categoryId   String?
  variants     ProductVariant[]
  menus        MenuProduct[]    // Relation many-to-many avec MenuDuJour
  orderItems   OrderItem[]
  cartItems     CartItem[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([restaurantId])
  @@index([categoryId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  label      String?  // e.g., "30cl", "1.5L", "Normal", "Grand"
  prix     Float
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  cartItems   CartItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

model Cart {
  id        String     @id @default(cuid())
  user      User       @relation(fields: [userId], references: [id])
  userId    String     @unique // Un utilisateur a un seul panier
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}
model CartItem {
  id        String   @id @default(cuid())
  cart      Cart     @relation(fields: [cartId], references: [id])
  cartId    String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  menu      MenuDuJour?  @relation(fields: [menuId], references: [id])
  menuId    String?
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  variantId String
  quantite  Int
  createdAt DateTime @default(now())
  
  @@unique([cartId, variantId, menuId]) // Permet un même variant comme produit individuel ET dans un menu
  @@index([variantId])
  @@index([productId])
  @@index([menuId])
}

model Order {
  id              String        @id @default(cuid())
  restaurant      Restaurant    @relation(fields: [restaurantId], references: [id])
  restaurantId    String
  userId          String        // Corresponds to User id
  subTotal        Float         // Sous-total des articles
  deliveryFee     Float         // Frais de livraison (0 si retrait)
  total           Float         // Montant total (subTotal + deliveryFee)
  isDelivery      Boolean       @default(true)  // true = livraison, false = retrait au restaurant
  deliveryAddress String?       // Adresse de livraison (null si retrait)
  deleteCommande  Boolean       @default(false)
  paymentMethod   PaymentMethod // Méthode de paiement
  status          OrderStatus   @default(EN_ATTENTE)
  paidAt          DateTime?     // Date de paiement
  notes           String?       // Notes optionnelles du client pour le restaurant
  items           OrderItem[]
  delivery        Delivery?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  Payment Payment[]

  @@index([restaurantId])
}

model OrderItem {
  id         String   @id @default(cuid())
  order      Order    @relation(fields: [orderId], references: [id])
  orderId    String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  menu       MenuDuJour?  @relation(fields: [menuId], references: [id])
  menuId     String?
  variant    String   // e.g., "1.5L"
  quantite   Int
  prix      Float
  createdAt  DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}
model Delivery {
  id          String         @id @default(cuid())
  order       Order          @relation(fields: [orderId], references: [id])
  orderId     String         @unique
  deliverer   User?          @relation(fields: [delivererId], references: [id])
  delivererId String?
  status      DeliveryStatus @default(EN_ATTENTE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([delivererId])
}

enum Role {
  ADMIN
  RESTAURATEUR
  LIVREUR
  CLIENT
}

enum PaymentMethod {
  CASH_ON_DELIVERY
  MTN_MOMO
}

enum OrderStatus {
  EN_ATTENTE
  PAYER
  EN_PREPARATION
  PRET
  LIVRER
  ANNULER
}

enum DeliveryStatus {
  EN_ATTENTE
  ASSIGNER
  EN_TRANSIT
  LIVRER
  ECHEC
}

model Payment {
  id                     String        @id @default(cuid())
  orderId                String
  amount                 Float
  currency               String        @default("XAF")
  phoneNumber            String
  status                 PaymentStatus @default(PENDING)
  provider               String        @default("MTN_MOMO")
  providerTransactionId  String?
  metadata               Json          @default("{}")
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  order                  Order         @relation(fields: [orderId], references: [id])

  @@map("payments")
  @@index([orderId])
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

// Mode de tarification de la livraison pour chaque restaurant
enum DeliveryPriceMode {
  FIXED       // Prix fixe pour toutes les livraisons
  ZONE_BASED  // Prix selon le quartier/zone
}

// Modèle pour les avis et notes des clients
model Review {
  id           String     @id @default(cuid())
  rating       Int        // Note de 1 à 5
  comment      String?    // Commentaire optionnel
  user         User       @relation(fields: [userId], references: [id])
  userId       String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  restaurantId String
  orderId      String?    // Optionnel: lié à une commande spécifique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([userId, restaurantId]) // Un utilisateur ne peut laisser qu'un seul avis par restaurant
  @@index([restaurantId])
  @@index([userId])
}

// Zones de livraison avec prix personnalisé par restaurant
model DeliveryZone {
  id           String     @id @default(cuid())
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId String
  zoneName     String     // Ex: "Zone 1", "Centre-ville", etc.
  fee          Float      // Prix de livraison pour cette zone
  quartiers    QuartierZone[] // Quartiers inclus dans cette zone
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([restaurantId])
}

// Liste des quartiers de Brazzaville
model Quartier {
  id        String         @id @default(cuid())
  nom       String         @unique  // Ex: "Bacongo", "Poto-Poto", "Talangaï"
  ville     String         @default("Brazzaville")
  zones     QuartierZone[]
  adresses  Adresses[]
  createdAt DateTime       @default(now())
}

// Table de liaison entre quartiers et zones de livraison
model QuartierZone {
  id             String       @id @default(cuid())
  quartier       Quartier     @relation(fields: [quartierId], references: [id], onDelete: Cascade)
  quartierId     String
  deliveryZone   DeliveryZone @relation(fields: [deliveryZoneId], references: [id], onDelete: Cascade)
  deliveryZoneId String

  @@unique([quartierId, deliveryZoneId])
  @@index([quartierId])
  @@index([deliveryZoneId])
}